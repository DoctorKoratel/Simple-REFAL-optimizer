$EXTERN LoadFile, WriteLine, Parser, Error, HardGen, FastGen, MakeIndexes;

MakePatterns {
	e.Pattern '=' e.Result ';' e.Tail = 
		(<Parser e.Pattern>) <MakePatterns e.Tail>;
	 = ;
	e.smth = <Error 'Bad scentence: ' e.smth>;
}

$FORWARD PrintPattern;

Test {
	(e.Sent) =
		<WriteLine 'Input sentence: ' e.Sent> 
		<PrintPattern
			('Patterns:') 
			<MakePatterns e.Sent>
		> 
		<PrintPattern
			('HardGen:')
			<HardGen <MakePatterns e.Sent>>
		>
		<PrintPattern
			('FastGen:')
			<FastGen <HardGen <MakePatterns e.Sent>>>
		>
		<WriteLine>;
}

$LABEL Atom, E, T, S, Brackets, Alt;

$EXTERN Map, Fetch;

VarName { #E = 'e'; #T = 't'; #S = 's'; }

PrintPattern-Aux {
	e.Expr =
		<Map
			{
				(#Atom s.Value) = '#' s.Value ' ';
				(#Brackets e.InBrackets) = '(' <PrintPattern-Aux e.InBrackets> ') ';
				(s.Var (e.Index) (#Alt e.Substs)) =
					<VarName s.Var> '.' e.Index '->['
					<Map
						{ (e.Pattern) = <PrintPattern-Aux e.Pattern> '|'; }
						e.Substs
					>
					'] ';
				(s.Var (e.Index) (e.Subst)) =
					<Fetch s.Var { #E = 'e'; #T = 't'; #S = 's'; }>
					'.' e.Index '->[' <PrintPattern-Aux e.Subst> '] ';
			}
			e.Expr
		>;
}

PrintPattern {
	(e.Message) e.Patterns =
		<WriteLine '\n' e.Message>
		<Map
			{
				(e.Pattern) = <WriteLine <PrintPattern-Aux e.Pattern>>;
			}
			e.Patterns
		>;
}

$ENTRY Go {
	 = <Map Test <LoadFile 'Test.txt'>>;
}